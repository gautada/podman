#!/bin/ash
#
# entrypoint: Located at `/etc/container/entrypoint` this script is the custom
#             entry for a container as called by `/usr/bin/container-entrypoint` set
#             in the upstream [alpine-container](https://github.com/gautada/alpine-container).
#             The default template is kept in
#             [gist](https://gist.github.com/gautada/f185700af585a50b3884ad10c2b02f98)

WETTY_USER="$(/usr/bin/whoami)"
WETTY_TITLE="PKI Client"
WETTY_COMMAND="/bin/ash"


ENTRYPOINT_PARAMS="$@"
. /etc/profile

app_version() {
 /usr/bin/podman --version |  awk -F ' ' '{print $3}'
}

# Make the server ssh key on start
if [ ! -f "/etc/ssh/ssh_host_rsa_key" ] ; then
 /usr/bin/sudo /usr/bin/ssh-keygen -A -t rsa -N ''
fi
# Launch the ssh daemon
/usr/bin/sudo /usr/sbin/sshd
# Setup the local ssh keys
if [ ! -f /home/$WETTY_USER/.ssh/id_rsa ] ; then
 /bin/mkdir /home/$WETTY_USER/.ssh
 /bin/chmod 700 /home/$WETTY_USER/.ssh
 /usr/bin/ssh-keygen -t rsa -N '' -f /home/$WETTY_USER/.ssh/id_rsa
 /bin/cp /home/$WETTY_USER/.ssh/id_rsa.pub /home/$WETTY_USER/.ssh/authorized_keys
 /bin/chmod 600 /home/$WETTY_USER/.ssh/authorized_keys
fi
 
/usr/bin/pgrep wetty > /dev/null
TEST=$?
if [ $TEST -eq 1 ] ; then
 /home/$WETTY_USER/.yarn/bin/wetty --base / --port 8080 --ssh-host localhost --ssh-user $WETTY_USER --ssh-auth publickey \
   --ssh-key /home/$WETTY_USER/.ssh/id_rsa --force-ssh --title $WETTY_TITLE \
   --command $WETTY_COMMAD >> /mnt/volumes/container/wetty.log 2>&1 &
fi

if [ -z "$@" ] ; then
 /usr/bin/pgrep /usr/bin/podman > /dev/null
 TEST=$?
 if [ $TEST -eq 1 ] ; then
  log "-i" "entrypoint" "Blocking podman($(app_version))"
  /usr/bin/podman --log-level fatal system service --time 0 tcp://0.0.0.0:3000
  fi
 return 1
else
 /usr/bin/pgrep /usr/bin/podman > /dev/null
 TEST=$?
 if [ $TEST -eq 1 ] ; then 
  log "-i" "entrypoint" "Forked podman($(app_version))"
  # tail -f /dev/null &
  /usr/bin/podman --log-level fatal system service --time 0 tcp://0.0.0.0:3000 >> /mnt/volumes/container/_log 2>&1 &
 fi
 return 0
fi
