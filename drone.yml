kind: pipeline
type: exec
name: Container Build - Drone

platform:
  os: linux
  arch: arm64

steps:
- name: build
  environment:
    ALPINE_VERSION: "latest"
    PODMAN_VERSION: 4.3.0
    DRONE_SERVER_VERSION: 2.16.0
    DRONE_CLI_VERSION: 1.6.2
    DRONE_RUNNER_DOCKER_VERSION: 1.8.1
    DRONE_RUNNER_EXEC_VERSION: 1.0.0-beta.9
    DRONE_RUNNER_KUBE_VERSION: 1.0.0-rc.3
  commands:
  - /usr/bin/podman build --build-arg ALPINE_VERSION=$ALPINE_VERSION --build-arg PODMAN_VERSION=$PODMAN_VERSION --build-arg DRONE_SERVER_VERSION=$DRONE_SERVER_VERSION --build-arg DRONE_CLI_VERSION=$DRONE_CLI_VERSION --build-arg DRONE_RUNNER_DOCKER_VERSION=$DRONE_RUNNER_DOCKER_VERSION --build-arg DRONE_RUNNER_EXEC_VERSION=$DRONE_RUNNER_EXEC_VERSION --build-arg DRONE_RUNNER_KUBE_VERSION=$DRONE_RUNNER_KUBE_VERSION --file Containerfile --label revision="$(git rev-parse HEAD)" --label version="$(date +%Y.%m.%d)" --format docker --no-cache --tag drone:drone .


- name: publish
  environment:
    CONTAINER_NAME: "drone"
    CONTAINER_VERSION: 2.16.0
    DOCKERIO_USERNAME:
      from_secret: username.docker.io
    DOCKERIO_PASSWORD:
      from_secret: password.docker.io
  commands:
   - /usr/bin/podman tag $CONTAINER_NAME:drone docker.io/$DOCKERIO_USERNAME/$CONTAINER_NAME:$CONTAINER_VERSION
   - /usr/bin/podman tag $CONTAINER_NAME:drone docker.io/$DOCKERIO_USERNAME/$CONTAINER_NAME:latest
   - /usr/bin/podman login --username=$DOCKERIO_USERNAME --password=$DOCKERIO_PASSWORD docker.io
   - /usr/bin/podman push docker.io/$DOCKERIO_USERNAME/$CONTAINER_NAME:$CONTAINER_VERSION
   - /usr/bin/podman push docker.io/$DOCKERIO_USERNAME/$CONTAINER_NAME:latest
   
trigger:
  branch:
  - main



  /usr/bin/podman build --build-arg ALPINE_VERSION=latest --build-arg PODMAN_VERSION=4.3.0 --build-arg DRONE_SERVER_VERSION=2.16.0 --build-arg DRONE_CLI_VERSION=1.6.2 --build-arg DRONE_RUNNER_DOCKER_VERSION=1.8.1 --build-arg DRONE_RUNNER_EXEC_VERSION=1.0.0-beta.9 --build-arg DRONE_RUNNER_KUBE_VERSION=1.0.0-rc.3 --file Containerfile --label revision="$(git rev-parse HEAD)" --label version="$(date +%Y.%m.%d)" --format docker --no-cache --tag drone:drone .
